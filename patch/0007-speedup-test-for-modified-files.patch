From 4c1b6c2514e83496076462ed0664e57aca558aec Mon Sep 17 00:00:00 2001
From: gstavi <gur.stavi@gmail.com>
Date: Wed, 15 Jul 2015 16:27:50 +0300
Subject: [PATCH 07/18] speedup test for modified files
MIME-Version: 1.0
Content-Type: multipart/mixed; boundary="------------2.30.0"

This is a multi-part message in MIME format.
--------------2.30.0
Content-Type: text/plain; charset=UTF-8; format=fixed
Content-Transfer-Encoding: 8bit


diff --git a/PowerEditor/src/Parameters.cpp b/PowerEditor/src/Parameters.cpp
index d7bed691..7c85e753 100644
--- a/PowerEditor/src/Parameters.cpp
+++ b/PowerEditor/src/Parameters.cpp
@@ -6744,7 +6744,25 @@ void NppParameters::addScintillaModifiedIndex(int index)
 
 void NppParameters::safeWow64EnableWow64FsRedirection(BOOL Wow64FsEnableRedirection)
 {
-	HMODULE kernel = GetModuleHandle(TEXT("kernel32"));
+    typedef BOOL (WINAPI *LPFN_WOW64ENABLEWOW64FSREDIRECTION)(BOOL);
+    static LPFN_WOW64ENABLEWOW64FSREDIRECTION Wow64EnableWow64FsRedirectionFunc = NULL;
+    static int FirstTime = 1;
+    HMODULE kernel;
+
+	/*
+	 * Gur: speed optimization so we don't lookup kernel32 again and again.
+	 * This is called during the process of checking if files were modified
+	 * outside Notepad++.
+	 */
+	 if (!FirstTime)
+	 {
+		if (Wow64EnableWow64FsRedirectionFunc != NULL)
+			Wow64EnableWow64FsRedirectionFunc(Wow64FsEnableRedirection);
+		return;
+	}
+
+	FirstTime = 0;
+	kernel = GetModuleHandle(TEXT("kernel32"));
 	if (kernel)
 	{
 		BOOL isWow64 = FALSE;
@@ -6757,8 +6775,7 @@ void NppParameters::safeWow64EnableWow64FsRedirection(BOOL Wow64FsEnableRedirect
 
 			if (isWow64)
 			{
-				typedef BOOL (WINAPI *LPFN_WOW64ENABLEWOW64FSREDIRECTION)(BOOL);
-				LPFN_WOW64ENABLEWOW64FSREDIRECTION Wow64EnableWow64FsRedirectionFunc = (LPFN_WOW64ENABLEWOW64FSREDIRECTION)GetProcAddress(kernel, "Wow64EnableWow64FsRedirection");
+				Wow64EnableWow64FsRedirectionFunc = (LPFN_WOW64ENABLEWOW64FSREDIRECTION)GetProcAddress(kernel, "Wow64EnableWow64FsRedirection");
 				if (Wow64EnableWow64FsRedirectionFunc)
 				{
 					Wow64EnableWow64FsRedirectionFunc(Wow64FsEnableRedirection);
diff --git a/PowerEditor/src/ScitillaComponent/Buffer.cpp b/PowerEditor/src/ScitillaComponent/Buffer.cpp
index 980c0159..2d325867 100644
--- a/PowerEditor/src/ScitillaComponent/Buffer.cpp
+++ b/PowerEditor/src/ScitillaComponent/Buffer.cpp
@@ -221,13 +221,24 @@ void Buffer::setFileName(const TCHAR *fn, LangType defaultLang)
 
 bool Buffer::checkFileState() // returns true if the status has been changed (it can change into DOC_REGULAR too). false otherwise
 {
+	WIN32_FILE_ATTRIBUTE_DATA attributes;
+
+	/* Gur: speed optimization.
+	 * Optimistic approach - try to finish as quickly as possible */
+	if (_currentStatus == DOC_REGULAR)
+	{
+		BOOL res;
+		res = GetFileAttributesEx(_fullPathName.c_str(), GetFileExInfoStandard, &attributes);
+		if (res != 0 && CompareFileTime(&_timeStamp, &attributes.ftLastWriteTime) == 0)
+			return false;
+	}
+
 	// 1. Unsaved document cannot change by environment
 	// 2. Monitoring is sent by NPPM_INTERNAL_RELOADSCROLLTOEND
 	// So no need to check file status for both the above cases
 	if (_currentStatus == DOC_UNNAMED || isMonitoringOn())
 		return false;
 
-	WIN32_FILE_ATTRIBUTE_DATA attributes;
 	bool isWow64Off = false;
 	NppParameters& nppParam = NppParameters::getInstance();
 
@@ -514,6 +525,9 @@ void FileManager::checkFilesystemChanges(bool bCheckOnlyCurrentBuffer)
 {
 	if (bCheckOnlyCurrentBuffer)
 	{
+		if (_pNotepadPlus == NULL) {
+			return;
+		}
 		Buffer* buffer = _pNotepadPlus->getCurrentBuffer();
 		buffer->checkFileState();
 	}

--------------2.30.0--


