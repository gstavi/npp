From 0dfc47f7e388caf007f1a6bb47a6c7f975738cca Mon Sep 17 00:00:00 2001
From: gstavi <gstavi@users.noreply.github.com>
Date: Mon, 2 Jan 2017 10:50:21 +0200
Subject: [PATCH 15/18] Destroy task list on losing focus
MIME-Version: 1.0
Content-Type: multipart/mixed; boundary="------------2.30.0"

This is a multi-part message in MIME format.
--------------2.30.0
Content-Type: text/plain; charset=UTF-8; format=fixed
Content-Transfer-Encoding: 8bit


To prevent "hanging" task list.

diff --git a/PowerEditor/src/WinControls/TaskList/TaskList.cpp b/PowerEditor/src/WinControls/TaskList/TaskList.cpp
index 78cc3e84..109b7af9 100644
--- a/PowerEditor/src/WinControls/TaskList/TaskList.cpp
+++ b/PowerEditor/src/WinControls/TaskList/TaskList.cpp
@@ -491,6 +491,10 @@ LRESULT TaskList::runProc(HWND hwnd, UINT Message, WPARAM wParam, LPARAM lParam)
 			{
 				moveSelection(1);
 			}
+			else if (msg->wParam == VK_ESCAPE || msg->wParam == VK_OEM_3)
+			{
+				::PostMessage(_hParent, WM_CLOSE, 0, 0);
+			}
 			return DLGC_WANTALLKEYS;
 		}
 
diff --git a/PowerEditor/src/WinControls/TaskList/TaskListDlg.cpp b/PowerEditor/src/WinControls/TaskList/TaskListDlg.cpp
index 937feaa9..c298986b 100644
--- a/PowerEditor/src/WinControls/TaskList/TaskListDlg.cpp
+++ b/PowerEditor/src/WinControls/TaskList/TaskListDlg.cpp
@@ -104,6 +104,10 @@ INT_PTR CALLBACK TaskListDlg::run_dlgProc(UINT Message, WPARAM wParam, LPARAM lP
 			return FALSE;
 		}
 
+		case WM_CLOSE:
+			::EndDialog(_hSelf, -1);
+			return TRUE;
+
 		case WM_DESTROY :
 		{
 			_taskList.destroy();
@@ -125,12 +129,6 @@ INT_PTR CALLBACK TaskListDlg::run_dlgProc(UINT Message, WPARAM wParam, LPARAM lP
 			return TRUE;
 		}
 
-		case WM_DRAWITEM :
-		{
-			drawItem((DRAWITEMSTRUCT *)lParam);
-			return TRUE;
-		}
-
 		case WM_NOTIFY:
 		{
 			switch (((LPNMHDR)lParam)->code)
@@ -147,6 +145,9 @@ INT_PTR CALLBACK TaskListDlg::run_dlgProc(UINT Message, WPARAM wParam, LPARAM lP
 					return TRUE;
 				}
 		
+				case NM_KILLFOCUS :
+					::PostMessage(_hSelf, WM_CLOSE, 0, 0);
+					return FALSE;
 				case NM_CLICK :
 				case NM_RCLICK :
 				{

--------------2.30.0--


